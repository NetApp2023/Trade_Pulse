{% extends 'user_management/base.html' %}
{% load static %}

{% block content %}
  <head>
    <link rel="stylesheet" href="{% static 'user_management/coin_details.css' %}">
    <title>Coin-Details</title>
  </head>
    <div class="coin-details">
    <div class="coin-header">
      <div class="header-content">
        <img src="{{ coin_details.icon_url }}" alt="{{ coin_details.symbol }}" height="50" width="50" />
        <div class="coin-info">
          <h1>{{ coin_details.name }}</h1>
          <p>({{ coin_details.symbol }}) &nbsp;</p>
          <p class="rank-box">#{{ coin_details.rank }} </p>
          <p style="font-weight: bold"> &nbsp;{{ coin_details.price }}</p>
        </div>
      </div>
    </div>

    <div class="chart-info">
      <p style="font-weight: bold;font-size: large">Price chart</p>
      <div class="change-info">
        <p>24h</p>
        <p style="font-weight: bold" class="{% if coin_details.change >= 0 %}positive{% else %}negative{% endif %} ">{{ coin_details.change }}%</p>
      </div>
      <div class="change-info">
        <p>High </p>
        <p style="font-weight: bold">${{ high_price }}</p>
      </div>
       <div class="change-info">
         <p>Low</p>
         <p style="font-weight: bold">${{ low_price }}</p>
       </div>
       <div class="change-info">
         <p>Average</p>
         <p style="font-weight: bold"> ${{ average_price }}</p>
       </div>
    </div>

 <div class="chart-and-buyers">
    <div style="margin-top: 30px">
      <canvas id="priceChart"></canvas>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    // Parse cleaned sparkline data
    const sparklineData = {{ cleaned_sparkline_data|safe }};
    const chartData = sparklineData.map(value => parseFloat(value));

    // Assuming your sparklineData contains timestamps in HH:mm format
    // Replace this with your actual time data
    const timeLabels = ['10am', '11am', '12pm', '1pm', '2pm', '3pm', '4pm', '5pm', '6pm', '7pm', '8pm', '9pm', '10pm', '11pm'];

    // Check if sparklineData is defined before creating the chart
    if (typeof sparklineData !== 'undefined' && sparklineData.length > 0) {
        // Create a smaller price chart with time on Y-axis
        const ctx = document.getElementById('priceChart').getContext('2d');

        // Set explicit width and height
        ctx.canvas.width = 1200; // Set your desired width
        ctx.canvas.height = 300; // Set your desired height

        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: 'Price',
                    data: chartData,
                    backgroundColor: 'rgba(106, 90, 205, 0.2)',
                    borderColor: '#6a5acd',
                    borderWidth: 2,
                    pointRadius: 1, // Smaller points
                    lineTension: 0.4, // Adjust line tension for a smoother curve
                    fill: true,
                }]
            },
            options: {
                responsive: false, // Disable automatic resizing
                maintainAspectRatio: false, // Disable aspect ratio constraints
                scales: {
                    x: {
                        display: false, // Hide X-axis labels
                    },
                    y: {
                        display: true, // Show Y-axis labels
                    }
                },
                plugins: {
                    legend: {
                        display: false,
                    },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                    },
                },
                // Set explicit width and height
                layout: {
                    padding: {
                        left: 0,
                        right: 0,
                        top: 0,
                        bottom: 0,
                    },
                },
            },
        });
    }
</script>

    <div class="top-buyers">
  <h2><span class="star-icon">&#9733;</span>Top 5 Buyers</h2>
  <table class="exchange-info">
    <thead>
      <tr>
        <th>Username</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      {% for buyer in top_buyers %}
        <tr>
          <td class="align-left"><span class="diamond-icon">â™¦</span>{{ buyer.user.username }}</td>
          <td class="align-left">${{ buyer.amount }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
 </div>
</div>

    <div class="chart-and-buyers ">
    <div class="exchange-info-container">
    <table class="exchange-info">
        <thead>
            <tr>
                <th colspan="3">{{ coin_details.name }} Exchange Listings</th>
            </tr>
            <tr>
                <th>Exchange</th>
                <th>BTC Price</th>
                <th>24h Trade Volume</th>
            </tr>
        </thead>
        <tbody>
            {% for exchange in exchanges %}
                <tr>
                    <td class="align-left">
                        <img src="{{ exchange.iconUrl }}" alt="{{ exchange.name }}" />
                        <strong>{{ exchange.name }}</strong>
                    </td>
                    <td>${{ exchange.btc_price }}</td>
                    <td class="align-left">${{ exchange.trade_volume }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

    <script>
  var coinDetails = {{ coin_details|safe }};
  if (!coinDetails) {
    // Handle the case where coinDetails is not defined
    console.error("Error: coinDetails is not defined.");
    coinDetails = { name: '', symbol: '' };  // Provide default values
  }
</script>

    <div class="coin-converter">
    <h2>Coin to Currency Converter</h2>

    <label for="coinAmount">Amount in {{ coin_details.symbol|default:'Bitcoin' }}:</label>
    <input type="number" id="coinAmount" placeholder="Enter amount" >

    <label for="fiatCurrency">Convert to:</label>
    <select id="fiatCurrency">
        <option value="usd">US Dollar (USD)</option>
        <option value="eur">Euro (EUR)</option>
        <option value="jpy">Japanese Yen (YEN)</option>
        <option value="rub">Russian Ruble (RUB)</option>
    </select>

    <button onclick="convertCoin()">Convert</button>

    <div id="coinResult"></div>
    <p style="color: #427D9D" id="conversionDate"></p>
</div>

     <script>
   async function convertCoin() {
    const coinAmount = document.getElementById('coinAmount').value;
    const fiatCurrency = document.getElementById('fiatCurrency').value;

    // Fetch real-time conversion rates from CoinGecko API
    const apiUrl = `https://api.coingecko.com/api/v3/simple/price?ids=${coinDetails.name}&vs_currencies=${fiatCurrency}`;
    const response = await fetch(apiUrl);
    const data = await response.json();

    // Check if the response structure is as expected
    if (data[coinDetails.name.toLowerCase()] && data[coinDetails.name.toLowerCase()][fiatCurrency] !== undefined) {
        const coinToCurrencyRate = data[coinDetails.name.toLowerCase()][fiatCurrency];
        const convertedAmount = (coinAmount * coinToCurrencyRate).toFixed(2);

        // Display the converted amount
        document.getElementById('coinResult').innerHTML = `Converted Amount: ${convertedAmount} ${fiatCurrency.toUpperCase()}`;

        // Display the current date
        const currentDate = new Date().toLocaleDateString();
        document.getElementById('conversionDate').innerHTML = `Conversion Date: ${currentDate}`;
    } else {
        document.getElementById('coinResult').innerHTML = 'Invalid fiat currency selected or data not available.';
        document.getElementById('conversionDate').innerHTML = ''; // Clear the date if conversion fails
    }
}

</script>
    </div>

{% endblock %}
